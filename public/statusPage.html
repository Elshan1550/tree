<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Seat Status</title>
    <style>
        /* Background Video Styling */
        #backgroundVideo {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            object-fit: cover;
            /* Ensures the video covers the entire screen without distortion */
            overflow: hidden;
        }

        /* Seat Styles */
        .seat {
            width: 50px;
            height: 50px;
            display: inline-block;
            border: 1px solid #ffffff;
            text-align: center;
            vertical-align: middle;
            line-height: 50px;
            box-sizing: border-box;
            opacity: 0.7;
            font-size: 12px;
            color: rgb(19, 1, 1);


        }


        .in {
            background-color: yellow;
        }

        .out {
            background-color: red;
        }

        .pending {
            background-color: white;
        }

        .unknown {
            background-color: lightgray;
        }

        .category-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
            grid-gap: 5px;
            align-items: start;
            margin-top: 20px;
            padding: 20px;
        }

        .category-title {
            font-size: 50px;
            color: rgb(255, 255, 255);
            margin: 10px 0;
            grid-column: 1 / -1;
        }

        #categoryButtons {
            margin-bottom: 20px;
        }

        button.category-button {
            margin-right: 10px;
            padding: 10px 20px;
        }

        h1 {
            font-family: 'Franklin Gothic Medium', 'Arial Narrow', Arial, sans-serif;
            /* Change the font */
            color: #ffe600;
            /* Set the color (SeaGreen, for example) */
            font-size: 46px;
            /* Adjust the size */
            text-align: center;
            /* Optional: Center-align the text */

        }
    </style>


    </style>
</head>

<body>
    <video autoplay muted loop id="backgroundVideo">
        <source src="/videos/background_video.mp4" type="video/mp4">
        Your browser does not support the video tag.
    </video>

    <h1>Sarasavi Gee Sisila - Seat Status Visualization</h1>
    <div id="categoryButtons"></div>
    <div id="seatContainer"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function () {
            fetchSeats();
            longPoll(); // Start long-polling
        });

        function longPoll() {
            fetch('/long-poll-tickets')
                .then(response => response.json())
                .then(data => {
                    if (data.message === 'Update') {
                        fetchSeats(); // Fetch latest data upon update
                    }
                    longPoll(); // Continue polling
                })
                .catch(error => {
                    console.error('Error with long polling:', error);
                    setTimeout(longPoll, 5000); // Retry after a delay if there's an error
                });
        }

        function fetchSeats() {
            fetch('/tickets')
                .then(response => response.json())
                .then(data => {
                    renderSeats(data);
                    renderCategoryButtons(data);
                })
                .catch(error => console.error('Error loading seat data:', error));
        }

        function renderSeats(seats) {
            const container = document.getElementById('seatContainer');
            container.innerHTML = ''; // Clear existing seats

            const categories = new Map();

            seats.forEach(seat => {
                const category = seat.category || 'Unknown';
                if (!categories.has(category)) {
                    categories.set(category, []);
                }
                categories.get(category).push(seat);
            });

            categories.forEach((seats, category) => {
                const categoryDiv = document.createElement('div');
                categoryDiv.id = `category-${category}`; // Useful for toggling display
                categoryDiv.className = 'category-container';
                const title = document.createElement('h2');
                title.innerText = category;
                title.className = 'category-title';
                categoryDiv.appendChild(title);

                seats.forEach(seat => {
                    const seatDiv = document.createElement('div');
                    seatDiv.className = `seat ${statusClassName(seat.status)}`;
                    seatDiv.innerHTML = seat.barcode; // Display barcode inside the box
                    categoryDiv.appendChild(seatDiv);
                });

                container.appendChild(categoryDiv);
            });
        }

        function renderCategoryButtons(data) {
            const categories = new Set(data.map(seat => seat.category || 'Unknown'));
            const buttonsContainer = document.getElementById('categoryButtons');
            buttonsContainer.innerHTML = ''; // Clear existing buttons

            categories.forEach(category => {
                const button = document.createElement('button');
                button.innerText = category;
                button.className = 'category-button';
                button.onclick = () => toggleCategory(category);
                buttonsContainer.appendChild(button);
            });
        }

        function toggleCategory(category) {
            const allCategories = document.querySelectorAll('.category-container');
            allCategories.forEach(cat => {
                if (cat.id === `category-${category}`) {
                    cat.style.display = 'grid';
                } else {
                    cat.style.display = 'none';
                }
            });
        }

        function statusClassName(status) {
            switch (status) {
                case 'In':
                    return 'in';
                case 'Out':
                    return 'out';
                case 'pending':
                    return 'pending';
                default:
                    return 'unknown';
            }
        }
    </script>
</body>

</html>